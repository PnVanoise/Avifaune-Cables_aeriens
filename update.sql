
-- schema cables73

ALTER TABLE cables73.t_inventaire_poteaux_erdf ADD COLUMN insee INTEGER;
ALTER TABLE cables73.t_inventaire_poteaux_erdf ADD CONSTRAINT t_inventaire_poteaux_erdf_insee_fk FOREIGN KEY (insee) REFERENCES cables73.t_communes(insee);
UPDATE cables73.t_inventaire_poteaux_erdf SET insee = c.insee FROM cables73.t_inventaire_poteaux_erdf p JOIN cables73.t_communes c ON p.commune=c.nom_commune;

ALTER TABLE cables73.t_inventaire_troncons_erdf ADD COLUMN insee INTEGER;
ALTER TABLE cables73.t_inventaire_troncons_erdf ADD CONSTRAINT t_inventaire_troncons_erdf_insee_fk FOREIGN KEY (insee) REFERENCES cables73.t_communes(insee);
UPDATE cables73.t_inventaire_troncons_erdf SET insee = c.insee FROM cables73.t_inventaire_troncons_erdf p JOIN cables73.t_communes c ON p.commune=c.nom_commune;


-- schema cables74
ALTER TABLE cables74.t_communes ADD CONSTRAINT t_communes_pk PRIMARY KEY (insee);

ALTER TABLE cables74.t_inventaire_poteaux_erdf ADD COLUMN insee INTEGER;
ALTER TABLE cables74.t_inventaire_poteaux_erdf ADD CONSTRAINT t_inventaire_poteaux_erdf_insee_fk FOREIGN KEY (insee) REFERENCES cables74.t_communes(insee);
UPDATE cables74.t_inventaire_poteaux_erdf SET insee = c.insee FROM cables74.t_inventaire_poteaux_erdf p JOIN cables74.t_communes c ON p.commune=c.nom_commune;

ALTER TABLE cables74.t_inventaire_troncons_erdf ADD COLUMN insee INTEGER;
ALTER TABLE cables74.t_inventaire_troncons_erdf ADD CONSTRAINT t_inventaire_troncons_erdf_insee_fk FOREIGN KEY (insee) REFERENCES cables74.t_communes(insee);
UPDATE cables74.t_inventaire_troncons_erdf SET insee = c.insee FROM cables74.t_inventaire_troncons_erdf p JOIN cables74.t_communes c ON p.commune=c.nom_commune;

-- ####################
-- Commune et insee (poteaux et troncon) schema cables73
-- ####################

DROP FUNCTION  cables73.f_tr_add_commune_poteaux() CASCADE;
DROP FUNCTION  cables73.f_tr_add_commune_troncons() CASCADE;

CREATE OR REPLACE FUNCTION cables73.f_tr_add_commune() RETURNS trigger AS $$
DECLARE
/* declenchement sur ajout ou modif d'une géométrie*/
geom_temp geometry;
new_commune text;
new_insee integer;
BEGIN
  geom_temp = ST_Centroid(NEW.geom);
  BEGIN
    SELECT nom_commune, c.insee INTO new_commune,new_insee FROM cables73.t_communes AS c WHERE ST_Intersects(geom_temp, c.geom);
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE EXCEPTION 'insee not found';
      WHEN TOO_MANY_ROWS THEN
        RAISE EXCEPTION 'insee not unique';
  END;
  NEW.commune = new_commune;
  NEW.insee = new_insee;
  RETURN NEW;
END;
$$
LANGUAGE PLPGSQL;

--
-- Name: tr_update_commune; Type: TRIGGER; Schema: cables73; Owner: intranetsigbdd
--
DROP TRIGGER IF EXISTS tr_update_commune ON cables73.t_inventaire_troncons_erdf;
CREATE TRIGGER tr_update_commune BEFORE INSERT OR UPDATE OF geom ON cables73.t_inventaire_troncons_erdf FOR EACH ROW EXECUTE PROCEDURE cables73.f_tr_add_commune();

--
-- Name: tr_update_commune; Type: TRIGGER; Schema: cables73; Owner: intranetsigbdd
--
DROP TRIGGER IF EXISTS tr_update_commune ON cables73.t_inventaire_poteaux_erdf;
CREATE TRIGGER tr_update_commune BEFORE INSERT OR UPDATE OF geom ON cables73.t_inventaire_poteaux_erdf FOR EACH ROW EXECUTE PROCEDURE cables73.f_tr_add_commune();

-- ####################
-- Zone Life (poteaux et troncon)
-- ####################

CREATE OR REPLACE FUNCTION cables73.f_tr_add_zone_life() RETURNS trigger AS $$
DECLARE
/* declenchement sur ajout ou modif d'une géométrie*/
geom_temp geometry;
count_zone_life integer;
BEGIN
  geom_temp = ST_Centroid(NEW.geom);
  SELECT count(z.id) INTO count_zone_life FROM cables73.zone_life AS z WHERE ST_Contains(z.geom, geom_temp);
  IF count_zone_life > 0 THEN
    NEW.zone_life = TRUE;
    RAISE INFO 'zone found';
  ELSE
    NEW.zone_life = FALSE;
    RAISE INFO 'zone not found';
  END IF;

  RETURN NEW;
END;
$$
LANGUAGE PLPGSQL;

ALTER TABLE cables73.t_inventaire_poteaux_erdf ADD COLUMN zone_life boolean;
ALTER TABLE cables73.t_inventaire_troncons_erdf ADD COLUMN zone_life boolean;

DROP TRIGGER IF EXISTS tr_update_zone_life ON cables73.t_inventaire_poteaux_erdf;
CREATE TRIGGER tr_update_zone_life BEFORE INSERT OR UPDATE OF geom ON cables73.t_inventaire_poteaux_erdf FOR EACH ROW EXECUTE PROCEDURE cables73.f_tr_add_zone_life();
DROP TRIGGER IF EXISTS tr_update_zone_life ON cables73.t_inventaire_troncons_erdf;
CREATE TRIGGER tr_update_zone_life BEFORE INSERT OR UPDATE OF geom ON cables73.t_inventaire_troncons_erdf FOR EACH ROW EXECUTE PROCEDURE cables73.f_tr_add_zone_life();

CREATE TABLE cables73.zone_life (id serial, geom geometry(POLYGON, 4326));
INSERT INTO cables73.zone_life (geom) SELECT ST_SetSrid(ST_GeomFromGeoJSON('{"type":"Polygon",
                    "coordinates":[[
                        [6.6393,46.4052],[6.7172,46.4077],[6.7576,46.4024],[6.7614,46.4],[6.7901,46.3929],[6.8053,46.3938],[6.8032,46.3911],[6.8063,46.3798],[6.801,46.3749],
                        [6.792,46.367],[6.7824,46.3664],[6.7714,46.3599],[6.7723,46.35],[6.7748,46.3471],[6.787,46.3323],[6.7965,46.3306],[6.8013,46.3208],[6.8228,46.3125],
                        [6.8317,46.3002],[6.8461,46.2907],[6.851,46.29],[6.8555,46.2917],[6.8639,46.2796],[6.8548,46.2562],[6.8405,46.2469],[6.8342,46.2374],[6.8223,46.231],
                        [6.8213,46.2241],[6.8037,46.2029],[6.8053,46.1996],[6.8071,46.1962],[6.8109,46.18],[6.8075,46.1776],[6.7937,46.164],[6.7918,46.1574],[6.7906,46.1541],
                        [6.7974,46.138],[6.8125,46.1318],[6.8154,46.1291],[6.8349,46.132],[6.8528,46.1265],[6.8973,46.1228],[6.8933,46.1055],[6.8852,46.0966],[6.8907,46.0834],
                        [6.8883,46.0731],[6.8807,46.0684],[6.8728,46.0518],[6.8881,46.0437],[6.9097,46.0518],[6.9222,46.0626],[6.9363,46.0641],[6.9381,46.054],[6.9513,46.0494],
                        [6.9608,46.0334],[6.963,46.0303],[6.9813,46.0184],[6.9871,46.0047],[7.0094,45.9969],[7.0205,45.981],[7.0128,45.9726],[7.0127,45.9659],[7.0361,45.9528],
                        [7.0415,45.9248],[7.0211,45.9146],[7.0087,45.9032],[7.0046,45.8859],[7.0031,45.8825],[6.9966,45.8728],[6.9928,45.8704],[6.9547,45.8602],[6.9377,45.847],
                        [6.9033,45.8426],[6.8794,45.8478],[6.8737,45.8422],[6.8701,45.8281],[6.8659,45.8261],[6.8615,45.8323],[6.8574,45.8343],[6.854,45.8369],[6.8403,45.8398],
                        [6.8217,45.8368],[6.8048,45.8165],[6.8072,45.8136],[6.8121,45.8077],[6.8118,45.7972],[6.804,45.7884],[6.8027,45.7782],[6.8074,45.7472],[6.816,45.7387],
                        [6.8095,45.7257],[6.8277,45.7049],[6.8404,45.6998],[6.8457,45.6938],[6.8462,45.6904],[6.8722,45.6801],[6.9015,45.6789],[6.9056,45.6768],[6.9065,45.6699],
                        [6.9023,45.6635],[6.9151,45.6607],[6.9163,45.6546],[6.915,45.6515],[6.9334,45.6464],[6.9669,45.6536],[6.9769,45.646],[6.9993,45.638],[6.9975,45.6312],
                        [6.9854,45.62],[6.979,45.5884],[6.9951,45.5711],[6.9907,45.5612],[6.9952,45.5438],[6.9921,45.5333],[7.0049,45.5183],[7.0009,45.5081],[7.0001,45.5046],
                        [7.0218,45.4967],[7.0512,45.496],[7.0549,45.4937],[7.0545,45.4872],[7.0464,45.4789],[7.0497,45.4725],[7.0785,45.4731],[7.1019,45.4683],[7.1011,45.4548],
                        [7.115,45.4408],[7.1137,45.434],[7.1504,45.4228],[7.1647,45.4129],[7.1826,45.4066],[7.1843,45.4032],[7.1777,45.3899],[7.1666,45.3829],[7.1606,45.3732],
                        [7.16,45.3594],[7.1358,45.3476],[7.1328,45.3304],[7.1243,45.3271],[7.1145,45.3287],[7.1108,45.3263],[7.1118,45.316],[7.1179,45.3103],[7.1221,45.2966],
                        [7.1354,45.2816],[7.1311,45.2717],[7.1352,45.2543],[7.1263,45.2459],[7.1115,45.2444],[7.0837,45.2245],[7.076,45.2119],[7.0665,45.2111],[7.0545,45.2224],
                        [7.0513,45.2251],[7.0416,45.2244],[7.0257,45.2164],[7.0014,45.2175],[6.9902,45.2108],[6.971,45.2076],[6.9635,45.2036],[6.9648,45.1967],[6.9542,45.1896],
                        [6.9514,45.1796],[6.943,45.176],[6.9452,45.1728],[6.8931,45.1655],[6.8862,45.1562],[6.8955,45.14],[6.8546,45.1284],[6.797,45.1527],[6.792,45.1531],
                        [6.7697,45.1591],[6.7474,45.1406],[6.7389,45.1373],[6.7114,45.1445],[6.7067,45.1434],[6.6788,45.1376],[6.6714,45.1246],[6.6501,45.1158],[6.6354,45.115],
                        [6.6301,45.1091],[6.6271,45.1026],[6.6368,45.093],[6.625,45.0973],[6.6247,45.0974],[6.6162,45.1004],[6.6077,45.104],[6.6038,45.1058],[6.5992,45.1076],
                        [6.5908,45.1111],[6.5839,45.1143],[6.5823,45.115],[6.5738,45.1183],[6.5653,45.1215],[6.5608,45.1228],[6.5568,45.1238],[6.5483,45.1253],[6.5398,45.1259],
                        [6.5313,45.1256],[6.5228,45.1243],[6.5162,45.1228],[6.5143,45.1222],[6.5058,45.1193],[6.4973,45.1162],[6.4922,45.1143],[6.4889,45.1127],[6.4804,45.1088],
                        [6.4729,45.1058],[6.4719,45.1052],[6.4634,45.1013],[6.4549,45.0983],[6.4513,45.0973],[6.4464,45.0956],[6.4379,45.0934],[6.4294,45.092],[6.4209,45.0919],
                        [6.4124,45.0932],[6.4039,45.0955],[6.3995,45.0973],[6.3954,45.0987],[6.3869,45.1036],[6.384,45.1058],[6.3785,45.1093],[6.3726,45.1143],[6.37,45.1162],
                        [6.3628,45.1228],[6.3615,45.1239],[6.3542,45.1313],[6.353,45.1324],[6.3463,45.1397],[6.3445,45.1417],[6.3388,45.1482],[6.336,45.1515],[6.3318,45.1567],
                        [6.3275,45.1626],[6.3255,45.1652],[6.3195,45.1737],[6.319,45.1745],[6.3138,45.1822],[6.3105,45.188],[6.3088,45.1907],[6.3038,45.1992],[6.302,45.2031],
                        [6.2993,45.2077],[6.2949,45.2162],[6.2935,45.2197],[6.2908,45.2247],[6.2866,45.2332],[6.285,45.2382],[6.2829,45.2416],[6.279,45.2501],[6.2766,45.2578],
                        [6.2747,45.2586],[6.2681,45.2666],[6.2663,45.2586],[6.2613,45.2501],[6.2596,45.2486],[6.2553,45.2416],[6.2511,45.2364],[6.2489,45.2332],[6.2426,45.2257],
                        [6.2418,45.2247],[6.2341,45.2169],[6.2333,45.2162],[6.2256,45.2097],[6.2227,45.2077],[6.2171,45.2041],[6.2086,45.1992],[6.2086,45.1992],[6.2001,45.1959],
                        [6.1916,45.1934],[6.1831,45.192],[6.1747,45.1919],[6.1662,45.1928],[6.1577,45.195],[6.1492,45.1981],[6.1471,45.1992],[6.1407,45.2024],[6.1329,45.2077],
                        [6.1322,45.2082],[6.1237,45.2157],[6.1233,45.2162],[6.116,45.2247],[6.1152,45.2257],[6.1104,45.2332],[6.1067,45.2402],[6.106,45.2416],[6.1025,45.2501],
                        [6.1002,45.2586],[6.0986,45.2671],[6.0982,45.2724],[6.0982,45.2724],[6.098,45.2756],[6.0982,45.2812],[6.0983,45.2841],[6.0994,45.2926],[6.1015,45.3011],
                        [6.1048,45.3096],[6.1067,45.3135],[6.109,45.3181],[6.1145,45.3266],[6.1152,45.3275],[6.122,45.3351],[6.1237,45.3367],[6.1314,45.3435],[6.1322,45.3442],
                        [6.1407,45.3495],[6.1463,45.352],[6.1492,45.3534],[6.1577,45.3564],[6.1662,45.3582],[6.1747,45.3591],[6.1831,45.3587],[6.1916,45.357],[6.2001,45.354],
                        [6.2046,45.352],[6.2086,45.3503],[6.2171,45.3446],[6.2184,45.3435],[6.2256,45.3372],[6.2278,45.3351],[6.2341,45.3283],[6.2357,45.3266],[6.2425,45.3181],
                        [6.2426,45.3179],[6.2482,45.3096],[6.2511,45.3042],[6.2532,45.3011],[6.2581,45.2926],[6.2596,45.2887],[6.2627,45.2841],[6.2667,45.2756],[6.2681,45.2677],
                        [6.2766,45.2721],[6.2772,45.2756],[6.2809,45.2841],[6.285,45.2902],[6.2858,45.2926],[6.2902,45.3011],[6.2935,45.3066],[6.2947,45.3096],[6.2993,45.3181],
                        [6.302,45.3222],[6.3041,45.3266],[6.3092,45.3351],[6.3105,45.3371],[6.314,45.3435],[6.319,45.3513],[6.3195,45.352],[6.3251,45.3605],[6.3275,45.3639],
                        [6.3308,45.369],[6.336,45.3759],[6.3372,45.3775],[6.344,45.386],[6.3445,45.3866],[6.3512,45.3945],[6.353,45.3967],[6.3588,45.403],[6.3615,45.406],
                        [6.3669,45.4115],[6.37,45.4146],[6.3757,45.42],[6.3785,45.4227],[6.3853,45.4285],[6.3869,45.43],[6.3954,45.4369],[6.3955,45.437],[6.4039,45.443],
                        [6.4083,45.4454],[6.4124,45.4479],[6.4209,45.4526],[6.425,45.4539],[6.4294,45.4557],[6.4379,45.4584],[6.4464,45.4603],[6.4549,45.4613],[6.4634,45.4617],
                        [6.4719,45.4616],[6.4804,45.461],[6.4889,45.4604],[6.4973,45.4598],[6.5058,45.4595],[6.5143,45.4603],[6.5228,45.4623],[6.5232,45.4624],[6.5313,45.466],
                        [6.5387,45.4709],[6.5398,45.4717],[6.5481,45.4794],[6.5483,45.4796],[6.5553,45.4879],[6.5568,45.4897],[6.561,45.4964],[6.5653,45.5031],[6.5662,45.5049],
                        [6.5706,45.5134],[6.5738,45.52],[6.5745,45.5219],[6.5775,45.5304],[6.5805,45.5389],[6.5823,45.5455],[6.5827,45.5474],[6.5842,45.5558],[6.5849,45.5643],
                        [6.5852,45.5728],[6.5848,45.5813],[6.5841,45.5898],[6.583,45.5983],[6.5823,45.6037],[6.5817,45.6068],[6.5803,45.6153],[6.5787,45.6238],[6.5773,45.6323],
                        [6.5761,45.6408],[6.5749,45.6493],[6.5738,45.6574],[6.5737,45.6577],[6.5724,45.6662],[6.5707,45.6747],[6.5686,45.6832],[6.5661,45.6917],[6.5653,45.6939],
                        [6.5612,45.7002],[6.5568,45.7042],[6.5483,45.7073],[6.5398,45.7072],[6.5313,45.7055],[6.5228,45.7032],[6.5143,45.701],[6.5114,45.7002],[6.5058,45.6984],
                        [6.4973,45.6958],[6.4889,45.6938],[6.4804,45.6921],[6.4774,45.6917],[6.4719,45.6907],[6.4634,45.6894],[6.4549,45.6885],[6.4464,45.688],[6.4379,45.688],
                        [6.4294,45.6881],[6.4209,45.6886],[6.4124,45.6895],[6.4039,45.6904],[6.3954,45.6913],[6.3916,45.6917],[6.3869,45.6921],[6.3785,45.6928],[6.37,45.6932],
                        [6.3615,45.6931],[6.353,45.6922],[6.3502,45.6917],[6.3445,45.6904],[6.336,45.6862],[6.3313,45.6832],[6.3275,45.68],[6.3224,45.6747],[6.319,45.6705],
                        [6.3161,45.6662],[6.3107,45.6577],[6.3105,45.6575],[6.3051,45.6493],[6.302,45.6449],[6.2992,45.6408],[6.2935,45.6334],[6.2925,45.6323],[6.285,45.6248],
                        [6.2839,45.6238],[6.2766,45.6183],[6.2717,45.6153],[6.2681,45.6131],[6.2596,45.6092],[6.2523,45.6068],[6.2511,45.6064],[6.2426,45.6047],[6.2341,45.6036],
                        [6.2256,45.6034],[6.2171,45.6037],[6.2086,45.6048],[6.2001,45.6064],[6.199,45.6068],[6.1916,45.609],[6.1831,45.6123],[6.1769,45.6153],[6.1747,45.6163],
                        [6.1662,45.6218],[6.1635,45.6238],[6.1577,45.6285],[6.1538,45.6323],[6.1492,45.6378],[6.1469,45.6408],[6.1416,45.6493],[6.1407,45.6516],[6.1382,45.6577],
                        [6.1357,45.6662],[6.1345,45.6747],[6.134,45.6832],[6.1345,45.6917],[6.1356,45.7002],[6.1378,45.7087],[6.1405,45.7172],[6.1407,45.7177],[6.1439,45.7257],
                        [6.1483,45.7342],[6.1492,45.7359],[6.1527,45.7427],[6.1574,45.7512],[6.1577,45.7516],[6.1623,45.7596],[6.1662,45.7675],[6.1664,45.7681],[6.1702,45.7766],
                        [6.1733,45.7851],[6.1747,45.7898],[6.1756,45.7936],[6.1774,45.8021],[6.179,45.8106],[6.1809,45.8191],[6.1825,45.8276],[6.1831,45.831],[6.184,45.8361],
                        [6.1859,45.8446],[6.1879,45.8531],[6.1906,45.8615],[6.1916,45.8649],[6.193,45.87],[6.1957,45.8785],[6.1991,45.887],[6.2001,45.8898],[6.202,45.8955],
                        [6.2049,45.904],[6.208,45.9125],[6.2086,45.9145],[6.2105,45.921],[6.2126,45.9295],[6.2147,45.938],[6.2164,45.9465],[6.2171,45.9505],[6.2177,45.955],
                        [6.219,45.9635],[6.2201,45.9719],[6.2213,45.9804],[6.2231,45.9889],[6.2249,45.9974],[6.2256,46.0003],[6.2268,46.0059],[6.2293,46.0144],[6.2326,46.0229],
                        [6.2341,46.0261],[6.2363,46.0314],[6.2408,46.0399],[6.2426,46.0426],[6.2461,46.0484],[6.2511,46.0551],[6.2525,46.0569],[6.2596,46.0649],[6.26,46.0654],
                        [6.2681,46.0737],[6.2682,46.0738],[6.2766,46.0818],[6.2771,46.0823],[6.285,46.0894],[6.2866,46.0908],[6.2935,46.097],[6.296,46.0993],[6.302,46.1047],
                        [6.3052,46.1078],[6.3105,46.1127],[6.3143,46.1163],[6.319,46.1207],[6.3233,46.1248],[6.3275,46.1287],[6.3323,46.1333],[6.336,46.1368],[6.3417,46.1418],
                        [6.3445,46.1444],[6.3513,46.1503],[6.353,46.1518],[6.3614,46.1588],[6.3615,46.1588],[6.37,46.1655],[6.3725,46.1673],[6.3785,46.1716],[6.3854,46.1757],
                        [6.3869,46.1768],[6.3954,46.182],[6.3999,46.1842],[6.4039,46.1866],[6.4124,46.1908],[6.4171,46.1927],[6.4209,46.1946],[6.4294,46.1985],[6.437,46.2012],
                        [6.4379,46.2016],[6.4464,46.2054],[6.4549,46.2085],[6.4583,46.2097],[6.4634,46.212],[6.4719,46.2158],[6.4775,46.2182],[6.4804,46.2197],[6.4889,46.2241],
                        [6.4939,46.2267],[6.4973,46.2287],[6.5058,46.2338],[6.5083,46.2352],[6.5143,46.239],[6.5224,46.2437],[6.5228,46.2439],[6.5313,46.2487],[6.5387,46.2522],
                        [6.5398,46.2528],[6.5483,46.2571],[6.5568,46.2606],[6.5569,46.2607],[6.5653,46.2639],[6.5738,46.2668],[6.5816,46.2692],[6.5823,46.2694],[6.5908,46.2718],
                        [6.5992,46.2745],[6.6077,46.2775],[6.6082,46.2776],[6.6162,46.2819],[6.6215,46.2861],[6.6247,46.2902],[6.627,46.2946],[6.6294,46.3031],[6.6302,46.3116],
                        [6.6302,46.3201],[6.6297,46.3286],[6.6292,46.3371],[6.6288,46.3456],[6.6287,46.3541],[6.6291,46.3626],[6.6297,46.3711],[6.6313,46.3795],[6.6331,46.388],
                        [6.6332,46.3885],[6.6357,46.3965],[6.6392,46.405],[6.6393,46.4052]
]]}'), 4326);

UPDATE cables73.t_inventaire_troncons_erdf SET geom=geom;
UPDATE cables73.t_inventaire_poteaux_erdf SET geom=geom;

-- ####################
-- Commune et insee (poteaux et troncon) schema cables74
-- ####################

DROP FUNCTION  cables74.f_tr_add_commune_poteaux() CASCADE;
DROP FUNCTION  cables74.f_tr_add_commune_troncons() CASCADE;

CREATE OR REPLACE FUNCTION cables74.f_tr_add_commune() RETURNS trigger AS $$
DECLARE
/* declenchement sur ajout ou modif d'une géométrie*/
geom_temp geometry;
new_commune text;
new_insee integer;
BEGIN
  geom_temp = ST_Centroid(NEW.geom);
  BEGIN
    SELECT nom_commune, c.insee INTO new_commune,new_insee FROM cables74.t_communes AS c WHERE ST_Intersects(geom_temp, c.geom);
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE EXCEPTION 'insee not found';
      WHEN TOO_MANY_ROWS THEN
        RAISE EXCEPTION 'insee not unique';
  END;
  NEW.commune = new_commune;
  NEW.insee = new_insee;
  RETURN NEW;
END;
$$
LANGUAGE PLPGSQL;

--
-- Name: tr_update_commune; Type: TRIGGER; Schema: cables74; Owner: intranetsigbdd
--
DROP TRIGGER IF EXISTS tr_update_commune ON cables74.t_inventaire_troncons_erdf;
CREATE TRIGGER tr_update_commune BEFORE INSERT OR UPDATE OF geom ON cables74.t_inventaire_troncons_erdf FOR EACH ROW EXECUTE PROCEDURE cables74.f_tr_add_commune();

--
-- Name: tr_update_commune; Type: TRIGGER; Schema: cables74; Owner: intranetsigbdd
--
DROP TRIGGER IF EXISTS tr_update_commune ON cables74.t_inventaire_poteaux_erdf;
CREATE TRIGGER tr_update_commune BEFORE INSERT OR UPDATE OF geom ON cables74.t_inventaire_poteaux_erdf FOR EACH ROW EXECUTE PROCEDURE cables74.f_tr_add_commune();

-- ####################
-- Zone Life (poteaux et troncon)
-- ####################

CREATE OR REPLACE FUNCTION cables74.f_tr_add_zone_life() RETURNS trigger AS $$
DECLARE
/* declenchement sur ajout ou modif d'une géométrie*/
geom_temp geometry;
count_zone_life integer;
BEGIN
  geom_temp = ST_Centroid(NEW.geom);
  SELECT count(z.id) INTO count_zone_life FROM cables74.zone_life AS z WHERE ST_Contains(z.geom, geom_temp);
  IF count_zone_life > 0 THEN
    NEW.zone_life = TRUE;
    RAISE INFO 'zone found';
  ELSE
    NEW.zone_life = FALSE;
    RAISE INFO 'zone not found';
  END IF;

  RETURN NEW;
END;
$$
LANGUAGE PLPGSQL;

ALTER TABLE cables74.t_inventaire_poteaux_erdf ADD COLUMN zone_life boolean;
ALTER TABLE cables74.t_inventaire_troncons_erdf ADD COLUMN zone_life boolean;

DROP TRIGGER IF EXISTS tr_update_zone_life ON cables74.t_inventaire_poteaux_erdf;
CREATE TRIGGER tr_update_zone_life BEFORE INSERT OR UPDATE OF geom ON cables74.t_inventaire_poteaux_erdf FOR EACH ROW EXECUTE PROCEDURE cables74.f_tr_add_zone_life();
DROP TRIGGER IF EXISTS tr_update_zone_life ON cables74.t_inventaire_troncons_erdf;
CREATE TRIGGER tr_update_zone_life BEFORE INSERT OR UPDATE OF geom ON cables74.t_inventaire_troncons_erdf FOR EACH ROW EXECUTE PROCEDURE cables74.f_tr_add_zone_life();

CREATE TABLE cables74.zone_life (id serial, geom geometry(POLYGON, 4326));
INSERT INTO cables74.zone_life (geom) SELECT ST_SetSrid(ST_GeomFromGeoJSON('{"type":"Polygon",
                    "coordinates":[[
                        [6.6393,46.4052],[6.7172,46.4077],[6.7576,46.4024],[6.7614,46.4],[6.7901,46.3929],[6.8053,46.3938],[6.8032,46.3911],[6.8063,46.3798],[6.801,46.3749],
                        [6.792,46.367],[6.7824,46.3664],[6.7714,46.3599],[6.7723,46.35],[6.7748,46.3471],[6.787,46.3323],[6.7965,46.3306],[6.8013,46.3208],[6.8228,46.3125],
                        [6.8317,46.3002],[6.8461,46.2907],[6.851,46.29],[6.8555,46.2917],[6.8639,46.2796],[6.8548,46.2562],[6.8405,46.2469],[6.8342,46.2374],[6.8223,46.231],
                        [6.8213,46.2241],[6.8037,46.2029],[6.8053,46.1996],[6.8071,46.1962],[6.8109,46.18],[6.8075,46.1776],[6.7937,46.164],[6.7918,46.1574],[6.7906,46.1541],
                        [6.7974,46.138],[6.8125,46.1318],[6.8154,46.1291],[6.8349,46.132],[6.8528,46.1265],[6.8973,46.1228],[6.8933,46.1055],[6.8852,46.0966],[6.8907,46.0834],
                        [6.8883,46.0731],[6.8807,46.0684],[6.8728,46.0518],[6.8881,46.0437],[6.9097,46.0518],[6.9222,46.0626],[6.9363,46.0641],[6.9381,46.054],[6.9513,46.0494],
                        [6.9608,46.0334],[6.963,46.0303],[6.9813,46.0184],[6.9871,46.0047],[7.0094,45.9969],[7.0205,45.981],[7.0128,45.9726],[7.0127,45.9659],[7.0361,45.9528],
                        [7.0415,45.9248],[7.0211,45.9146],[7.0087,45.9032],[7.0046,45.8859],[7.0031,45.8825],[6.9966,45.8728],[6.9928,45.8704],[6.9547,45.8602],[6.9377,45.847],
                        [6.9033,45.8426],[6.8794,45.8478],[6.8737,45.8422],[6.8701,45.8281],[6.8659,45.8261],[6.8615,45.8323],[6.8574,45.8343],[6.854,45.8369],[6.8403,45.8398],
                        [6.8217,45.8368],[6.8048,45.8165],[6.8072,45.8136],[6.8121,45.8077],[6.8118,45.7972],[6.804,45.7884],[6.8027,45.7782],[6.8074,45.7472],[6.816,45.7387],
                        [6.8095,45.7257],[6.8277,45.7049],[6.8404,45.6998],[6.8457,45.6938],[6.8462,45.6904],[6.8722,45.6801],[6.9015,45.6789],[6.9056,45.6768],[6.9065,45.6699],
                        [6.9023,45.6635],[6.9151,45.6607],[6.9163,45.6546],[6.915,45.6515],[6.9334,45.6464],[6.9669,45.6536],[6.9769,45.646],[6.9993,45.638],[6.9975,45.6312],
                        [6.9854,45.62],[6.979,45.5884],[6.9951,45.5711],[6.9907,45.5612],[6.9952,45.5438],[6.9921,45.5333],[7.0049,45.5183],[7.0009,45.5081],[7.0001,45.5046],
                        [7.0218,45.4967],[7.0512,45.496],[7.0549,45.4937],[7.0545,45.4872],[7.0464,45.4789],[7.0497,45.4725],[7.0785,45.4731],[7.1019,45.4683],[7.1011,45.4548],
                        [7.115,45.4408],[7.1137,45.434],[7.1504,45.4228],[7.1647,45.4129],[7.1826,45.4066],[7.1843,45.4032],[7.1777,45.3899],[7.1666,45.3829],[7.1606,45.3732],
                        [7.16,45.3594],[7.1358,45.3476],[7.1328,45.3304],[7.1243,45.3271],[7.1145,45.3287],[7.1108,45.3263],[7.1118,45.316],[7.1179,45.3103],[7.1221,45.2966],
                        [7.1354,45.2816],[7.1311,45.2717],[7.1352,45.2543],[7.1263,45.2459],[7.1115,45.2444],[7.0837,45.2245],[7.076,45.2119],[7.0665,45.2111],[7.0545,45.2224],
                        [7.0513,45.2251],[7.0416,45.2244],[7.0257,45.2164],[7.0014,45.2175],[6.9902,45.2108],[6.971,45.2076],[6.9635,45.2036],[6.9648,45.1967],[6.9542,45.1896],
                        [6.9514,45.1796],[6.943,45.176],[6.9452,45.1728],[6.8931,45.1655],[6.8862,45.1562],[6.8955,45.14],[6.8546,45.1284],[6.797,45.1527],[6.792,45.1531],
                        [6.7697,45.1591],[6.7474,45.1406],[6.7389,45.1373],[6.7114,45.1445],[6.7067,45.1434],[6.6788,45.1376],[6.6714,45.1246],[6.6501,45.1158],[6.6354,45.115],
                        [6.6301,45.1091],[6.6271,45.1026],[6.6368,45.093],[6.625,45.0973],[6.6247,45.0974],[6.6162,45.1004],[6.6077,45.104],[6.6038,45.1058],[6.5992,45.1076],
                        [6.5908,45.1111],[6.5839,45.1143],[6.5823,45.115],[6.5738,45.1183],[6.5653,45.1215],[6.5608,45.1228],[6.5568,45.1238],[6.5483,45.1253],[6.5398,45.1259],
                        [6.5313,45.1256],[6.5228,45.1243],[6.5162,45.1228],[6.5143,45.1222],[6.5058,45.1193],[6.4973,45.1162],[6.4922,45.1143],[6.4889,45.1127],[6.4804,45.1088],
                        [6.4729,45.1058],[6.4719,45.1052],[6.4634,45.1013],[6.4549,45.0983],[6.4513,45.0973],[6.4464,45.0956],[6.4379,45.0934],[6.4294,45.092],[6.4209,45.0919],
                        [6.4124,45.0932],[6.4039,45.0955],[6.3995,45.0973],[6.3954,45.0987],[6.3869,45.1036],[6.384,45.1058],[6.3785,45.1093],[6.3726,45.1143],[6.37,45.1162],
                        [6.3628,45.1228],[6.3615,45.1239],[6.3542,45.1313],[6.353,45.1324],[6.3463,45.1397],[6.3445,45.1417],[6.3388,45.1482],[6.336,45.1515],[6.3318,45.1567],
                        [6.3275,45.1626],[6.3255,45.1652],[6.3195,45.1737],[6.319,45.1745],[6.3138,45.1822],[6.3105,45.188],[6.3088,45.1907],[6.3038,45.1992],[6.302,45.2031],
                        [6.2993,45.2077],[6.2949,45.2162],[6.2935,45.2197],[6.2908,45.2247],[6.2866,45.2332],[6.285,45.2382],[6.2829,45.2416],[6.279,45.2501],[6.2766,45.2578],
                        [6.2747,45.2586],[6.2681,45.2666],[6.2663,45.2586],[6.2613,45.2501],[6.2596,45.2486],[6.2553,45.2416],[6.2511,45.2364],[6.2489,45.2332],[6.2426,45.2257],
                        [6.2418,45.2247],[6.2341,45.2169],[6.2333,45.2162],[6.2256,45.2097],[6.2227,45.2077],[6.2171,45.2041],[6.2086,45.1992],[6.2086,45.1992],[6.2001,45.1959],
                        [6.1916,45.1934],[6.1831,45.192],[6.1747,45.1919],[6.1662,45.1928],[6.1577,45.195],[6.1492,45.1981],[6.1471,45.1992],[6.1407,45.2024],[6.1329,45.2077],
                        [6.1322,45.2082],[6.1237,45.2157],[6.1233,45.2162],[6.116,45.2247],[6.1152,45.2257],[6.1104,45.2332],[6.1067,45.2402],[6.106,45.2416],[6.1025,45.2501],
                        [6.1002,45.2586],[6.0986,45.2671],[6.0982,45.2724],[6.0982,45.2724],[6.098,45.2756],[6.0982,45.2812],[6.0983,45.2841],[6.0994,45.2926],[6.1015,45.3011],
                        [6.1048,45.3096],[6.1067,45.3135],[6.109,45.3181],[6.1145,45.3266],[6.1152,45.3275],[6.122,45.3351],[6.1237,45.3367],[6.1314,45.3435],[6.1322,45.3442],
                        [6.1407,45.3495],[6.1463,45.352],[6.1492,45.3534],[6.1577,45.3564],[6.1662,45.3582],[6.1747,45.3591],[6.1831,45.3587],[6.1916,45.357],[6.2001,45.354],
                        [6.2046,45.352],[6.2086,45.3503],[6.2171,45.3446],[6.2184,45.3435],[6.2256,45.3372],[6.2278,45.3351],[6.2341,45.3283],[6.2357,45.3266],[6.2425,45.3181],
                        [6.2426,45.3179],[6.2482,45.3096],[6.2511,45.3042],[6.2532,45.3011],[6.2581,45.2926],[6.2596,45.2887],[6.2627,45.2841],[6.2667,45.2756],[6.2681,45.2677],
                        [6.2766,45.2721],[6.2772,45.2756],[6.2809,45.2841],[6.285,45.2902],[6.2858,45.2926],[6.2902,45.3011],[6.2935,45.3066],[6.2947,45.3096],[6.2993,45.3181],
                        [6.302,45.3222],[6.3041,45.3266],[6.3092,45.3351],[6.3105,45.3371],[6.314,45.3435],[6.319,45.3513],[6.3195,45.352],[6.3251,45.3605],[6.3275,45.3639],
                        [6.3308,45.369],[6.336,45.3759],[6.3372,45.3775],[6.344,45.386],[6.3445,45.3866],[6.3512,45.3945],[6.353,45.3967],[6.3588,45.403],[6.3615,45.406],
                        [6.3669,45.4115],[6.37,45.4146],[6.3757,45.42],[6.3785,45.4227],[6.3853,45.4285],[6.3869,45.43],[6.3954,45.4369],[6.3955,45.437],[6.4039,45.443],
                        [6.4083,45.4454],[6.4124,45.4479],[6.4209,45.4526],[6.425,45.4539],[6.4294,45.4557],[6.4379,45.4584],[6.4464,45.4603],[6.4549,45.4613],[6.4634,45.4617],
                        [6.4719,45.4616],[6.4804,45.461],[6.4889,45.4604],[6.4973,45.4598],[6.5058,45.4595],[6.5143,45.4603],[6.5228,45.4623],[6.5232,45.4624],[6.5313,45.466],
                        [6.5387,45.4709],[6.5398,45.4717],[6.5481,45.4794],[6.5483,45.4796],[6.5553,45.4879],[6.5568,45.4897],[6.561,45.4964],[6.5653,45.5031],[6.5662,45.5049],
                        [6.5706,45.5134],[6.5738,45.52],[6.5745,45.5219],[6.5775,45.5304],[6.5805,45.5389],[6.5823,45.5455],[6.5827,45.5474],[6.5842,45.5558],[6.5849,45.5643],
                        [6.5852,45.5728],[6.5848,45.5813],[6.5841,45.5898],[6.583,45.5983],[6.5823,45.6037],[6.5817,45.6068],[6.5803,45.6153],[6.5787,45.6238],[6.5773,45.6323],
                        [6.5761,45.6408],[6.5749,45.6493],[6.5738,45.6574],[6.5737,45.6577],[6.5724,45.6662],[6.5707,45.6747],[6.5686,45.6832],[6.5661,45.6917],[6.5653,45.6939],
                        [6.5612,45.7002],[6.5568,45.7042],[6.5483,45.7073],[6.5398,45.7072],[6.5313,45.7055],[6.5228,45.7032],[6.5143,45.701],[6.5114,45.7002],[6.5058,45.6984],
                        [6.4973,45.6958],[6.4889,45.6938],[6.4804,45.6921],[6.4774,45.6917],[6.4719,45.6907],[6.4634,45.6894],[6.4549,45.6885],[6.4464,45.688],[6.4379,45.688],
                        [6.4294,45.6881],[6.4209,45.6886],[6.4124,45.6895],[6.4039,45.6904],[6.3954,45.6913],[6.3916,45.6917],[6.3869,45.6921],[6.3785,45.6928],[6.37,45.6932],
                        [6.3615,45.6931],[6.353,45.6922],[6.3502,45.6917],[6.3445,45.6904],[6.336,45.6862],[6.3313,45.6832],[6.3275,45.68],[6.3224,45.6747],[6.319,45.6705],
                        [6.3161,45.6662],[6.3107,45.6577],[6.3105,45.6575],[6.3051,45.6493],[6.302,45.6449],[6.2992,45.6408],[6.2935,45.6334],[6.2925,45.6323],[6.285,45.6248],
                        [6.2839,45.6238],[6.2766,45.6183],[6.2717,45.6153],[6.2681,45.6131],[6.2596,45.6092],[6.2523,45.6068],[6.2511,45.6064],[6.2426,45.6047],[6.2341,45.6036],
                        [6.2256,45.6034],[6.2171,45.6037],[6.2086,45.6048],[6.2001,45.6064],[6.199,45.6068],[6.1916,45.609],[6.1831,45.6123],[6.1769,45.6153],[6.1747,45.6163],
                        [6.1662,45.6218],[6.1635,45.6238],[6.1577,45.6285],[6.1538,45.6323],[6.1492,45.6378],[6.1469,45.6408],[6.1416,45.6493],[6.1407,45.6516],[6.1382,45.6577],
                        [6.1357,45.6662],[6.1345,45.6747],[6.134,45.6832],[6.1345,45.6917],[6.1356,45.7002],[6.1378,45.7087],[6.1405,45.7172],[6.1407,45.7177],[6.1439,45.7257],
                        [6.1483,45.7342],[6.1492,45.7359],[6.1527,45.7427],[6.1574,45.7512],[6.1577,45.7516],[6.1623,45.7596],[6.1662,45.7675],[6.1664,45.7681],[6.1702,45.7766],
                        [6.1733,45.7851],[6.1747,45.7898],[6.1756,45.7936],[6.1774,45.8021],[6.179,45.8106],[6.1809,45.8191],[6.1825,45.8276],[6.1831,45.831],[6.184,45.8361],
                        [6.1859,45.8446],[6.1879,45.8531],[6.1906,45.8615],[6.1916,45.8649],[6.193,45.87],[6.1957,45.8785],[6.1991,45.887],[6.2001,45.8898],[6.202,45.8955],
                        [6.2049,45.904],[6.208,45.9125],[6.2086,45.9145],[6.2105,45.921],[6.2126,45.9295],[6.2147,45.938],[6.2164,45.9465],[6.2171,45.9505],[6.2177,45.955],
                        [6.219,45.9635],[6.2201,45.9719],[6.2213,45.9804],[6.2231,45.9889],[6.2249,45.9974],[6.2256,46.0003],[6.2268,46.0059],[6.2293,46.0144],[6.2326,46.0229],
                        [6.2341,46.0261],[6.2363,46.0314],[6.2408,46.0399],[6.2426,46.0426],[6.2461,46.0484],[6.2511,46.0551],[6.2525,46.0569],[6.2596,46.0649],[6.26,46.0654],
                        [6.2681,46.0737],[6.2682,46.0738],[6.2766,46.0818],[6.2771,46.0823],[6.285,46.0894],[6.2866,46.0908],[6.2935,46.097],[6.296,46.0993],[6.302,46.1047],
                        [6.3052,46.1078],[6.3105,46.1127],[6.3143,46.1163],[6.319,46.1207],[6.3233,46.1248],[6.3275,46.1287],[6.3323,46.1333],[6.336,46.1368],[6.3417,46.1418],
                        [6.3445,46.1444],[6.3513,46.1503],[6.353,46.1518],[6.3614,46.1588],[6.3615,46.1588],[6.37,46.1655],[6.3725,46.1673],[6.3785,46.1716],[6.3854,46.1757],
                        [6.3869,46.1768],[6.3954,46.182],[6.3999,46.1842],[6.4039,46.1866],[6.4124,46.1908],[6.4171,46.1927],[6.4209,46.1946],[6.4294,46.1985],[6.437,46.2012],
                        [6.4379,46.2016],[6.4464,46.2054],[6.4549,46.2085],[6.4583,46.2097],[6.4634,46.212],[6.4719,46.2158],[6.4775,46.2182],[6.4804,46.2197],[6.4889,46.2241],
                        [6.4939,46.2267],[6.4973,46.2287],[6.5058,46.2338],[6.5083,46.2352],[6.5143,46.239],[6.5224,46.2437],[6.5228,46.2439],[6.5313,46.2487],[6.5387,46.2522],
                        [6.5398,46.2528],[6.5483,46.2571],[6.5568,46.2606],[6.5569,46.2607],[6.5653,46.2639],[6.5738,46.2668],[6.5816,46.2692],[6.5823,46.2694],[6.5908,46.2718],
                        [6.5992,46.2745],[6.6077,46.2775],[6.6082,46.2776],[6.6162,46.2819],[6.6215,46.2861],[6.6247,46.2902],[6.627,46.2946],[6.6294,46.3031],[6.6302,46.3116],
                        [6.6302,46.3201],[6.6297,46.3286],[6.6292,46.3371],[6.6288,46.3456],[6.6287,46.3541],[6.6291,46.3626],[6.6297,46.3711],[6.6313,46.3795],[6.6331,46.388],
                        [6.6332,46.3885],[6.6357,46.3965],[6.6392,46.405],[6.6393,46.4052]
]]}'), 4326);

UPDATE cables74.t_inventaire_troncons_erdf SET geom=geom;
UPDATE cables74.t_inventaire_poteaux_erdf SET geom=geom;
